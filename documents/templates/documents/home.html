{% load static %}
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Diminished Value Intake & Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>

body{
background:linear-gradient(135deg,#c9a7a7,#e6d3d3);
font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

.container{
margin-top:30px;
margin-bottom:40px;
}

.card{
border:none;
border-radius:18px;
background:rgba(255,255,255,.95);
box-shadow:0 10px 30px rgba(0,0,0,.2);
margin-bottom:25px;
}

.card-header{
background:linear-gradient(90deg,#111,#333);
color:#fff;
border-radius:18px 18px 0 0!important;
font-weight:600;
}

.section-title{
font-weight:700;
margin-top:25px;
margin-bottom:12px;
padding-bottom:6px;
border-bottom:2px solid rgba(0,0,0,.2);
}

.form-control,.form-select{
border-radius:10px;
}

.btn{
border-radius:10px;
font-weight:600;
}

.report{
background:#fff;
padding:40px;
font-family:"Times New Roman",Times,serif;
}

.report-header{
text-align:center;
margin-bottom:25px;
}

.report-header img{
max-width:100%;
}

.report h1{
font-size:22pt;
margin-top:15px;
margin-bottom:20px;
}

.report table{
width:100%;
border-collapse:collapse;
margin-bottom:18px;
}

.report td,.report th{
border:1px solid #000;
padding:8px 10px;
}

.report td:first-child{
font-weight:bold;
width:240px;
}

.signature{
margin-top:35px;
}

.signature img{
width:260px;
}

@media print{

.no-print{
display:none!important;
}

body{
background:#fff;
}

.card{
box-shadow:none;
border:none;
}

.report{
padding:.75in;
}

}

</style>

</head>
<body>

<div class="container">

<div class="card no-print">

<div class="card-header">
Diminished Value Intake
<span class="float-end">Report ID: <span id="report_number_display">New</span></span>
</div>

<div class="card-body">


<div class="section-title">Vehicle Selector</div>

<div class="row g-3">

<div class="col-md-3">
<label>Year</label>
<select id="vehicle_year" class="form-select"></select>
</div>

<div class="col-md-3">
<label>Make</label>
<select id="vehicle_make" class="form-select">
<option></option>
<option>Acura</option>
<option>Audi</option>
<option>BMW</option>
<option>Chevrolet</option>
<option>Ford</option>
<option>Genesis</option>
<option>Honda</option>
<option>Hyundai</option>
<option>Mercedes-Benz</option>
<option>Nissan</option>
<option>Tesla</option>
<option>Toyota</option>
<option>Volkswagen</option>
</select>
</div>

<div class="col-md-3">
<label>Model</label>
<input id="vehicle_model" class="form-control">
</div>

<div class="col-md-3">
<label>Trim</label>
<input id="vehicle_trim" class="form-control">
</div>

</div>


<div class="section-title">Case Intake</div>

<div class="row g-3">

<div class="col-md-4">
<label>Claimant Name</label>
<input id="claimant_name" class="form-control">
</div>

<div class="col-md-4">
<label>Email</label>
<input id="client_email" class="form-control">
</div>

<div class="col-md-4">
<label>Phone</label>
<input id="client_phone" class="form-control">
</div>

<div class="col-md-4">
<label>Insurance Company</label>
<input id="insurance_company" class="form-control">
</div>

<div class="col-md-4">
<label>Claim Number</label>
<input id="claim_number" class="form-control">
</div>

<div class="col-md-4">
<label>Loss Date</label>
<input id="loss_date" type="date" class="form-control">
</div>

<div class="col-md-4">
<label>Report Date</label>
<input id="report_date" type="date" class="form-control">
</div>

<div class="col-md-4">
<label>Appraiser</label>
<input id="appraiser_name" value="David L. Montanaro" class="form-control">
</div>

<div class="col-md-4">
<label>Pre-Loss Condition</label>
<select id="preloss_condition" class="form-select">
<option>Excellent</option>
<option>Good</option>
<option>Fair</option>
<option>Poor</option>
</select>
</div>

<div class="col-md-4">
<label>Loss Type</label>
<select id="loss_type" class="form-select">
<option>Collision</option>
<option>Comprehensive</option>
<option>Liability</option>
</select>
</div>

</div>


<div class="section-title">Vehicle Details</div>

<div class="row g-3">

<div class="col-md-4">
<label>VIN</label>
<input id="vin" class="form-control">
</div>

<div class="col-md-4">
<label>Mileage</label>
<input id="mileage" type="number" class="form-control">
</div>

<div class="col-md-4">
<label>State</label>
<input id="state" class="form-control">
</div>

<div class="col-md-4">
<label>Color / Trim Description</label>
<input id="color_trim" class="form-control">
</div>

</div>


<div class="section-title">Valuation Inputs</div>

<div class="row g-3">

<div class="col-md-3">
<label>Pre-Loss Retail Value</label>
<input id="preloss_retail" type="number" class="form-control">
</div>

<div class="col-md-3">
<label>Base Loss %</label>
<input id="base_loss_pct" type="number" class="form-control">
</div>

<div class="col-md-3">
<label>Damage Modifier %</label>
<input id="damage_modifier" type="number" class="form-control">
</div>

<div class="col-md-3">
<label>Mileage Modifier %</label>
<input id="mileage_modifier" type="number" class="form-control">
</div>

<div class="col-md-3">
<label>Other Modifier %</label>
<input id="other_modifier" type="number" class="form-control">
</div>

</div>


<div class="section-title">Damage Summary</div>

<div class="row g-3">

<div class="col-md-6">
<label>Repair Facility</label>
<input id="repair_facility" class="form-control">
</div>

<div class="col-md-6">
<label>Repair Total</label>
<input id="repair_total" type="number" class="form-control">
</div>

<div class="col-md-12">
<label>Damage Description</label>
<textarea id="damage_description" class="form-control" rows="4"></textarea>
</div>

</div>


<div class="mt-3">

<button class="btn btn-dark" onclick="saveReport()">Save</button>

<button class="btn btn-outline-dark" onclick="saveAndPrint()">Save / Print PDF</button>

</div>


</div>
</div>



<div class="card">

<div class="card-body report">

<div class="report-header">
<img src="{% static 'documents/header.png' %}">
<h1>DIMINISHED VALUE APPRAISAL REPORT</h1>
</div>


<table>

<tr><td>Claimant</td><td id="r_claimant_name"></td></tr>
<tr><td>Insurance Company</td><td id="r_insurance_company"></td></tr>
<tr><td>Claim Number</td><td id="r_claim_number"></td></tr>
<tr><td>Loss Date</td><td id="r_loss_date"></td></tr>
<tr><td>Report Date</td><td id="r_report_date"></td></tr>

<tr>
<td>Vehicle</td>
<td id="r_vehicle"></td>
</tr>

<tr><td>VIN</td><td id="r_vin"></td></tr>
<tr><td>Mileage</td><td id="r_mileage"></td></tr>

</table>


<table>

<tr><th>Description</th><th>Amount</th></tr>

<tr>
<td>Pre-Loss Retail Value</td>
<td id="r_preloss"></td>
</tr>

<tr>
<td>Base Diminished Value</td>
<td id="r_base"></td>
</tr>

<tr>
<td>Adjusted Diminished Value</td>
<td id="r_adjusted"></td>
</tr>

</table>


<div class="signature">
<img src="{% static 'documents/signature.png' %}">
<div id="r_appraiser"></div>
</div>


</div>
</div>


</div>



<script>

let report_id=null

const y=document.getElementById("vehicle_year")

for(let i=new Date().getFullYear();i>=1990;i--)
y.add(new Option(i,i))


function money(v){
return "$"+Number(v||0).toFixed(2)
}


function sync(){

const pre=+preloss_retail.value||0
const pct=+base_loss_pct.value||0

const mod=
(+damage_modifier.value||0)+
(+mileage_modifier.value||0)+
(+other_modifier.value||0)

const base=pre*(pct/100)
const adj=base*(1+mod/100)


r_claimant_name.textContent=claimant_name.value
r_insurance_company.textContent=insurance_company.value
r_claim_number.textContent=claim_number.value
r_loss_date.textContent=loss_date.value
r_report_date.textContent=report_date.value

r_vehicle.textContent=
vehicle_year.value+" "+
vehicle_make.value+" "+
vehicle_model.value+" "+
vehicle_trim.value

r_vin.textContent=vin.value
r_mileage.textContent=mileage.value

r_preloss.textContent=money(pre)
r_base.textContent=money(base)
r_adjusted.textContent=money(adj)

r_appraiser.textContent=appraiser_name.value

}


document.querySelectorAll("input,select,textarea")
.forEach(e=>e.addEventListener("input",sync))


function saveReport(){

const data={

id:report_id,

claimant_name:claimant_name.value,
client_email:client_email.value,
client_phone:client_phone.value,

insurance_company:insurance_company.value,
claim_number:claim_number.value,

loss_date:loss_date.value,
report_date:report_date.value,

appraiser_name:appraiser_name.value,

vehicle_year:vehicle_year.value,
vehicle_make:vehicle_make.value,
vehicle_model:vehicle_model.value,
vehicle_trim:vehicle_trim.value,

vin:vin.value,
mileage:mileage.value,

state:state.value,
color_trim:color_trim.value,

preloss_condition:preloss_condition.value,
loss_type:loss_type.value,

repair_facility:repair_facility.value,
repair_total:repair_total.value,

preloss_retail:preloss_retail.value,
base_loss_pct:base_loss_pct.value,

damage_modifier:damage_modifier.value,
mileage_modifier:mileage_modifier.value,
other_modifier:other_modifier.value,

damage_description:damage_description.value

}


fetch("/save-report/",{

method:"POST",

headers:{
"Content-Type":"application/json",
"X-CSRFToken":"{{ csrf_token }}"
},

body:JSON.stringify(data)

})
.then(r=>r.json())
.then(res=>{
report_id=res.id
report_number_display.textContent=res.id
})

}

sync()

function saveAndPrint(){

saveReport()

setTimeout(()=>{
window.print()
},500)

}

</script>


</body>
</html>